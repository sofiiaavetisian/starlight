name: CD

on:
  push:
    branches:
      - main

concurrency:
  group: cd-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    name: Build and Deploy to Azure Container Apps
    runs-on: ubuntu-latest

    env:
      IMAGE_NAME: starlight-app

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Log in to Azure Container Registry
        run: az acr login --name ${{ secrets.AZURE_CONTAINER_REGISTRY }}

      - name: Build and push container image
        env:
          REGISTRY_LOGIN_SERVER: ${{ secrets.AZURE_CONTAINER_REGISTRY_LOGIN_SERVER }}
        run: |
          docker build -t $REGISTRY_LOGIN_SERVER/$IMAGE_NAME:${{ github.sha }} .
          docker push $REGISTRY_LOGIN_SERVER/$IMAGE_NAME:${{ github.sha }}

          docker tag $REGISTRY_LOGIN_SERVER/$IMAGE_NAME:${{ github.sha }} \
            $REGISTRY_LOGIN_SERVER/$IMAGE_NAME:latest
          docker push $REGISTRY_LOGIN_SERVER/$IMAGE_NAME:latest

      - name: Ensure Container Apps extension
        run: |
          az config set extension.use_dynamic_install=yes_without_prompt
          az extension add --name containerapp --upgrade

      - name: Deploy Django container to Azure Container Apps
        env:
          REGISTRY_LOGIN_SERVER: ${{ secrets.AZURE_CONTAINER_REGISTRY_LOGIN_SERVER }}
          REGISTRY_USERNAME: ${{ secrets.AZURE_CONTAINER_REGISTRY_USERNAME }}
          REGISTRY_PASSWORD: ${{ secrets.AZURE_CONTAINER_REGISTRY_PASSWORD }}
          RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
          CONTAINERAPPS_ENVIRONMENT: ${{ secrets.AZURE_CONTAINERAPPS_ENVIRONMENT }}
          CONTAINERAPP_NAME: ${{ secrets.AZURE_CONTAINERAPPS_APP_NAME }}
          DJANGO_SECRET_KEY: ${{ secrets.DJANGO_SECRET_KEY }}
          DJANGO_ALLOWED_HOSTS: ${{ secrets.DJANGO_ALLOWED_HOSTS }}
        run: |
          IMAGE="$REGISTRY_LOGIN_SERVER/$IMAGE_NAME:${{ github.sha }}"

          if az containerapp show --name "$CONTAINERAPP_NAME" --resource-group "$RESOURCE_GROUP" >/dev/null 2>&1; then
            echo "Container App exists, setting registry and updating..."

            az containerapp registry set \
              --name "$CONTAINERAPP_NAME" \
              --resource-group "$RESOURCE_GROUP" \
              --server "$REGISTRY_LOGIN_SERVER" \
              --username "$REGISTRY_USERNAME" \
              --password "$REGISTRY_PASSWORD"

            # Set or update secrets separately for existing app
            az containerapp secret set \
              --name "$CONTAINERAPP_NAME" \
              --resource-group "$RESOURCE_GROUP" \
              --secrets django-secret-key="$DJANGO_SECRET_KEY"

            az containerapp update \
              --name "$CONTAINERAPP_NAME" \
              --resource-group "$RESOURCE_GROUP" \
              --image "$IMAGE" \
              --set-env-vars \
                SECRET_KEY=secretref:django-secret-key \
                DJANGO_ALLOWED_HOSTS="$DJANGO_ALLOWED_HOSTS" \
                DEBUG=0 \
                PYTHONDONTWRITEBYTECODE=1 \
                PYTHONUNBUFFERED=1
          else
            echo "Container App does not exist, creating..."

            az containerapp create \
              --name "$CONTAINERAPP_NAME" \
              --resource-group "$RESOURCE_GROUP" \
              --environment "$CONTAINERAPPS_ENVIRONMENT" \
              --image "$IMAGE" \
              --registry-server "$REGISTRY_LOGIN_SERVER" \
              --registry-username "$REGISTRY_USERNAME" \
              --registry-password "$REGISTRY_PASSWORD" \
              --ingress external \
              --target-port 8000 \
              --min-replicas 1 \
              --max-replicas 1 \
              --secrets django-secret-key="$DJANGO_SECRET_KEY" \
              --env-vars \
                SECRET_KEY=secretref:django-secret-key \
                DJANGO_ALLOWED_HOSTS="$DJANGO_ALLOWED_HOSTS" \
                DEBUG=0 \
                PYTHONDONTWRITEBYTECODE=1 \
                PYTHONUNBUFFERED=1
          fi
